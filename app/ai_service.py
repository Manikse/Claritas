from openai import OpenAI
import os

# Ініціалізація клієнта OpenAI
# ВАЖЛИВО: Ключ береться з конфігурації Flask, а не з os.environ.get
# Однак, оскільки ви використовуєте os.environ.get, залишимо так, але краще передавати його з app.config.
client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY")) 

def generate_campaign_copy(topic, audience, benefit, placement):
    """
    Генерує повний рекламний контент (заголовки, текст, CTA)
    на основі СЕКРЕТНОГО ПРОМПТУ (gpt-4o).
    """
    
    # === Компонент 1: Роль Експерта (system_prompt) ===
    # Це ваша головна конкурентна перевага
    system_prompt = (
        "Ти — Гуру Маркетингу та НЛП, високооплачуваний копірайтер. "
        "Твоя задача — створити рекламні матеріали, що мають психологічний вплив та високу конверсію. "
        "Фокус: страх втрати, терміновість, вигоди, що змінюють життя. "
        "Відповідь має бути строго структурована за розділами, як вказано у запиті."
    )
    
    # === Компонент 2 & 3: Об'єднаний Запит Користувача та Формат Виводу (full_prompt) ===
    full_prompt = f"""
    Створи повний пакет рекламного контенту для кампанії. Дотримуйся всіх інструкцій.

    ### ДАНІ ПРОДУКТУ ###
    1. ТЕМА ПРОДУКТУ: {topic}
    2. ЦІЛЬОВА АУДИТОРІЯ: {audience}
    3. КЛЮЧОВА ВИГОДА: {benefit} (Наголоси на цій вигоді як на вирішенні БОЛЮ)
    4. МІСЦЕ РОЗМІЩЕННЯ: {placement} (Врахуй обмеження та стиль цієї платформи)

    ### ФОРМАТ ТА ВИМОГИ ###

    1. **ЗАГОЛОВКИ (HEADLINES):** Створи 10 варіантів. 5 мають використовувати формулу AIDA, 5 – формулу Problem-Agitate-Solve (PAS). Вони мають бути короткі та агресивні.
    2. **ТІЛО РЕКЛАМИ (AD BODY):** Створи 3 повноцінні абзаци, що використовують формулу PAS. Включи емоційний тригер.
    3. **ЗАКЛИКИ ДО ДІЇ (CTAs):** Створи 5 варіантів, що використовують терміновість.

    Надай відповідь виключно у форматі, готовому для копіювання:
    
    ## ЗАГОЛОВКИ (10 варіантів, агресивних)
    1. ...
    ...

    ## ТІЛО РЕКЛАМИ (3 варіанти, за формулою PAS)
    1. [Проблема]... [Ажитація]... [Рішення]...
    ...

    ## ЗАКЛИКИ ДО ДІЇ (5 варіантів, з фокусом на терміновість)
    1. ...
    ...
    """
    
    try:
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": full_prompt} 
            ]
        )
        return response.choices[0].message.content
    except Exception as e:
        # Обробка помилок API (важливо для стабільності)
        print(f"Помилка AI API: {e}")
        return "Виникла помилка під час генерації контенту. Спробуйте пізніше."